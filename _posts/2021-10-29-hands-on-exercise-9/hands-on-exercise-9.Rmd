---
title: "Hands-on Exercise 9"
description: |
  In this hands-on exercise, I learn how to calibrate geographicailly weighted regression models by using GWmodel package of R.
author:
  - name: Ngah Xin Yan
    url: https://github.com/nxinyan/
date: 10-29-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.retina = 3)
```

# Overview

Geographically weighted regression (GWR) is a spatial statistical technique that takes non-stationary variables into consideration (e.g., climate; demographic factors; physical environment characteristics) and models the local relationships between these independent variables and an outcome of interest (also known as dependent variable). In this hands-on exercise, you will learn how to build hedonic pricing models by using GWR methods. The dependent variable is the resale prices of condominium in 2015. The independent variables are divided into either structural and locational.

## Data Used

The following datasets were used:

- URA Master Plan subzone boundary in shapefile format (i.e. MP14_SUBZONE_WEB_PL)
- condo_resale_2015 in csv format (i.e. condo_resale_2015.csv)

## Installing and Loading the R packages

- [**olsrr**](https://olsrr.rsquaredacademy.com/index.html): for building OLS and performing diagnostics tests

- [**GWmodel**](https://cran.r-project.org/web/packages/GWmodel/index.html): to calibrate geographical weighted family of models

- [**corrplot**](https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html): for multivariate data visualisation and analysis

- **sf**: spatial data handling

- **tidyverse**: attribute data handling

- **tmap**: choropleth mapping

```{r}
packages = c('olsrr', 'corrplot', 'ggpubr', 'sf', 'spdep', 'GWmodel', 'tmap', 'tidyverse')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

## Note on GWmodel

[**GWmodel**](https://cran.r-project.org/web/packages/GWmodel/index.html) package provides a collection of localised spatial statistical methods:

- GW summary statistics
- GW principal components analysis
- GW discriminant analysis
- various forms of GW regression (provided in basic or robust (outlier resistant) forms)

Commonly, outputs or parameters of the GWmodel are mapped to provide a useful exploratory tool, which can often precede (and direct) a more traditional or sophisticated statistical analysis.

# Geospatial Data Wrangling

## Importing geospatial data

*MP14_SUBZONE_WEB_PL* is the geospatial data used. It is in ESRI shapefile format.The shapefile consists of URA Master Plan 2014’s planning subzone boundaries. Polygon features are used to represent these geographic boundaries. The GIS data is in svy21 projected coordinates systems.

```{r}
mpsz = st_read(dsn = "data/geospatial", layer = "MP14_SUBZONE_WEB_PL")
```

Assigned the MP14_SUBZONE_WEB_PL shapefile to *mpsz*. It is a simple feature object. The geometry type is multipolygon. it is also important to note that mpsz simple feature object does not have EPSG information.

## Updating CRS information

```{r}
mpsz_svy21 <- st_transform(mpsz, 3414)
```

Verifying the projection of the newly transformed *mpsz_svy21* by using st_crs() of sf package

```{r}
st_crs(mpsz_svy21)
```

Reveal extent of mpsz_svy21 using *st_bbox()* of sf package.

```{r}
st_bbox(mpsz_svy21)
```

# Aspatial Data Wrangling

## Importing the aspatial data

The *condo_resale_2015* is in csv file format. The codes chunk below uses *read_csv()* function of **readr** package to import *condo_resale_2015* into R as a tibble data frame called *condo_resale*.

```{r}
condo_resale = read_csv("data/aspatial/Condo_resale_2015.csv")
```

After importing the data file into R, it is important to examine if the data file has been imported correctly.

Learning more about the associated attribute information in the data frame. 

```{r}
glimpse(condo_resale)
```

To see the data in XCOORD column 

```{r}
head(condo_resale$LONGITUDE) 
```

To see the data in YCOORD column

```{r}
head(condo_resale$LATITUDE) 
```

```{r}
summary(condo_resale)
```

## Converting aspatial data frame into a sf object

The *condo resale* data frame is aspatial. Converting *condo_resale* data frame into a simple feature data frame by using *st_as_sf()*.

*st_transform()*  is also used to convert the coordinates from wgs84 to svy21

```{r}
condo_resale.sf <- st_as_sf(condo_resale,
                            coords = c("LONGITUDE", "LATITUDE"),
                            crs=4326) %>%
  st_transform(crs=3414)
head(condo_resale.sf)
```

# Exploratory Data Analysis

## EDA using statistical graphics

Plotting the distribution of SELLING_PRICE by using appropriate Exploratory Data Analysis (EDA)

```{r}
ggplot(data=condo_resale.sf, aes(x=`SELLING_PRICE`)) +
  geom_histogram(bins=20, color="black", fill="light blue")
```

More condominium units were transacted at a relative lower price as it is a right skewed distribution.

Statistically, the skewed dsitribution can be normalised by using log transformation. It is performed using mutate() of dplyr package.

```{r}
condo_resale.sf <- condo_resale.sf %>%
  mutate(`LOG_SELLING_PRICE` = log(SELLING_PRICE))
```

Plot the ***LOG_SELLING_PRICE***

```{r}
ggplot(data=condo_resale.sf, aes(x=`LOG_SELLING_PRICE`)) +
  geom_histogram(bins=20, color="black", fill="light blue")
```

The distribution of the histogram is less skewed after the transformation.

## Multiple Histogram Plots distribution of variables

Drawing small multiple histograms by using ggarrange() of ggpubr package.

```{r}
AREA_SQM <- ggplot(data=condo_resale.sf, aes(x= `AREA_SQM`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

AGE <- ggplot(data=condo_resale.sf, aes(x= `AGE`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_CBD <- ggplot(data=condo_resale.sf, aes(x= `PROX_CBD`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_CHILDCARE <- ggplot(data=condo_resale.sf, aes(x= `PROX_CHILDCARE`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_ELDERLYCARE <- ggplot(data=condo_resale.sf, aes(x= `PROX_ELDERLYCARE`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_URA_GROWTH_AREA <- ggplot(data=condo_resale.sf, aes(x= `PROX_URA_GROWTH_AREA`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_HAWKER_MARKET <- ggplot(data=condo_resale.sf, aes(x= `PROX_HAWKER_MARKET`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_KINDERGARTEN <- ggplot(data=condo_resale.sf, aes(x= `PROX_KINDERGARTEN`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_MRT <- ggplot(data=condo_resale.sf, aes(x= `PROX_MRT`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_PARK <- ggplot(data=condo_resale.sf, aes(x= `PROX_PARK`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_PRIMARY_SCH <- ggplot(data=condo_resale.sf, aes(x= `PROX_PRIMARY_SCH`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

PROX_TOP_PRIMARY_SCH <- ggplot(data=condo_resale.sf, aes(x= `PROX_TOP_PRIMARY_SCH`)) +
  geom_histogram(bins=20, color="black", fill="light blue")

ggarrange(AREA_SQM, AGE, PROX_CBD, PROX_CHILDCARE, PROX_ELDERLYCARE, PROX_URA_GROWTH_AREA, PROX_HAWKER_MARKET, PROX_KINDERGARTEN, PROX_MRT, PROX_PARK, PROX_PRIMARY_SCH, PROX_TOP_PRIMARY_SCH,  ncol = 3, nrow = 4)
```

## Drawing Statistical Point Map

Revealing the geospatial distribution condominium resale prices in Singapore.

Using interactive mode

```{r}
tmap_mode("view")
```

Create an interactive point symbol map

```{r}
tmap_options(check.and.fix = TRUE)
tm_shape(mpsz_svy21)+
  tm_polygons() +
tm_shape(condo_resale.sf) +  
  tm_dots(col = "SELLING_PRICE",
          alpha = 0.6,
          style="quantile") +
  tm_view(set.zoom.limits = c(11,14))
```

*set.zoom.limits* argument of *tm_view()* sets the minimum and maximum zoom level to 11 and 14 respectively.

Turn R display into plot mode

```{r}
tmap_mode("plot")
```

# Hedonic Pricing Modelling in R

Learning how to building hedonic pricing models for condominium resale units using *lm()* of R base.

## Simple Linear Regression Method

Building a simple linear regression model by using *SELLING_PRICE* as the dependent variable and *AREA_SQM* as the independent variable.

```{r}
condo.slr <- lm(formula=SELLING_PRICE ~ AREA_SQM, data = condo_resale.sf)
```

*lm()* returns an object of class “lm” or for multiple responses of class c(“mlm”, “lm”).

The functions *summary()* and *anova()* can be used to obtain and print a summary and analysis of variance table of the results. The generic accessor functions coefficients, effects, fitted.values and residuals extract various useful features of the value returned by **lm**.

```{r}
summary(condo.slr)
```

The output report reveals that the SELLING_PRICE can be explained by using the formula:

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

